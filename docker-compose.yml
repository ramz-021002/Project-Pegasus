version: '3.8'

services:
  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: pegasus-postgres
    environment:
      POSTGRES_USER: pegasus
      POSTGRES_PASSWORD: pegasus_dev_password
      POSTGRES_DB: pegasus_db
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U pegasus" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - pegasus_network

  # Redis for Celery broker and result backend
  redis:
    image: redis:7-alpine
    container_name: pegasus-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - pegasus_network

  # FastAPI Backend (Development)
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: pegasus-backend
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql://pegasus:pegasus_dev_password@postgres:5432/pegasus_db
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - DEBUG=True
      - SECRET_KEY=dev_secret_key_change_in_production
      - ENCRYPTION_KEY=dev_encryption_key_32_chars_min
      - ALLOWED_ORIGINS=["http://localhost:3000","http://localhost:5173"]
      - DOCKER_SOCKET=unix:///var/run/docker.sock
      - UPLOAD_DIR=/app/quarantine
      - HOST_QUARANTINE_PATH=${PWD}/quarantine
      - LOG_LEVEL=INFO
    volumes:
      - ./backend:/app
      - /var/run/docker.sock:/var/run/docker.sock
      - ./quarantine:/app/quarantine
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - pegasus_network

  # Celery Worker
  celery-worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: pegasus-celery-worker
    command: celery -A app.tasks.orchestration worker --loglevel=info
    environment:
      - DATABASE_URL=postgresql://pegasus:pegasus_dev_password@postgres:5432/pegasus_db
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - DEBUG=True
      - SECRET_KEY=dev_secret_key_change_in_production
      - ENCRYPTION_KEY=dev_encryption_key_32_chars_min
      - DOCKER_SOCKET=unix:///var/run/docker.sock
      - UPLOAD_DIR=/app/quarantine
      - HOST_QUARANTINE_PATH=${PWD}/quarantine
      - LOG_LEVEL=INFO
    volumes:
      - ./backend:/app
      - /var/run/docker.sock:/var/run/docker.sock
      - ./quarantine:/app/quarantine
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - pegasus_network

  # Frontend Web UI
  frontend:
    image: nginx:alpine
    container_name: pegasus-frontend
    ports:
      - "3000:80"
    volumes:
      - ./frontend:/usr/share/nginx/html:ro
      - ./frontend/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - backend
    networks:
      - pegasus_network

  # Network Gateway (Fake DNS/Internet)
  network-gateway:
    build:
      context: ./docker/network-gateway
      dockerfile: Dockerfile
    container_name: pegasus-network-gateway
    ports:
      - "1053:53/udp"
      - "1080:80"
      - "1443:443"
    networks:
      pegasus_network:
        ipv4_address: 172.20.0.10
    cap_add:
      - NET_ADMIN
    volumes:
      - ./captures:/tmp/captures
    restart: unless-stopped

  # Example: Dynamic Analysis Container (uncomment and adapt as needed)
  dynamic-analysis:
    build:
      context: ./docker/dynamic-analysis
      dockerfile: Dockerfile
    container_name: pegasus-dynamic-analysis
    user: root
    networks:
      pegasus_network:
        ipv4_address: 172.20.0.20
    dns:
      - 172.20.0.10 # Use network-gateway for DNS
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - NO_EXTERNAL_NET=1
    cap_add:
      - NET_ADMIN
    # Block all outbound except to gateway
    command: [ "/bin/sh", "-c", "iptables -P OUTPUT DROP; iptables -A OUTPUT -d 172.20.0.10 -j ACCEPT; exec python3 /analysis/monitor.py /analysis/sample" ]

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local

networks:
  pegasus_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
          gateway: 172.20.0.1
