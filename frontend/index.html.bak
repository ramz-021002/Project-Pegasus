<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Pegasus - Malware Analysis Platform</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Fira Code', 'Courier New', monospace;
            background: #0a0a0a;
            color: #c0c0c0;
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .ascii-header {
            color: #ff3333;
            white-space: pre;
            font-size: 10px;
            line-height: 1.2;
            margin-bottom: 30px;
            text-align: center;
            text-shadow: 0 0 10px rgba(255, 51, 51, 0.5);
        }

        @media (max-width: 768px) {
            .ascii-header { font-size: 6px; }
        }

        .card {
            background: #111;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .card-title {
            color: #fff;
            font-size: 1.1em;
            font-weight: 700;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }

        .card-subtitle {
            color: #888;
            font-size: 0.85em;
            margin-bottom: 15px;
        }

        .note {
            color: #666;
            font-size: 0.8em;
            margin-bottom: 15px;
        }

        .upload-form {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 15px;
        }

        .file-input-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-btn {
            background: #222;
            border: 1px solid #444;
            color: #c0c0c0;
            padding: 8px 15px;
            border-radius: 3px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9em;
            transition: all 0.2s;
        }

        .file-btn:hover {
            background: #333;
            border-color: #555;
        }

        .file-name {
            color: #888;
            font-size: 0.85em;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .file-name.has-file {
            color: #ffcc00;
        }

        .file-name.has-file::before {
            content: "‚ö† ";
            color: #ffcc00;
        }

        input[type="file"] { display: none; }

        .input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-group label {
            color: #888;
            font-size: 0.9em;
        }

        .text-input {
            background: #1a1a1a;
            border: 1px solid #333;
            color: #c0c0c0;
            padding: 8px 12px;
            border-radius: 3px;
            font-family: inherit;
            font-size: 0.9em;
            width: 120px;
        }

        .text-input:focus {
            outline: none;
            border-color: #ff3333;
        }

        .analyze-btn {
            background: #1a1a1a;
            border: 1px solid #444;
            color: #c0c0c0;
            padding: 8px 20px;
            border-radius: 3px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9em;
            transition: all 0.2s;
        }

        .analyze-btn:hover {
            background: #2a2a2a;
            border-color: #ff3333;
            color: #ff3333;
        }

        .analyze-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .status-msg {
            margin-top: 20px;
            padding: 10px 0;
        }

        .status-msg.success { color: #33ff33; }
        .status-msg.error { color: #ff3333; }
        .status-msg.info { color: #ffcc00; }

        .prefix { font-weight: bold; }
        .prefix.success { color: #33ff33; }
        .prefix.error { color: #ff3333; }
        .prefix.info { color: #ffcc00; }

        .result-header {
            color: #33ff33;
            font-size: 1em;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .result-classification {
            color: #ff3333;
            font-size: 1.2em;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .result-meta {
            color: #888;
            font-size: 0.85em;
            margin-bottom: 20px;
        }

        .result-meta span { margin-right: 15px; }

        .tracer-output {
            background: #0a0a0a;
            border: 1px solid #222;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-size: 0.8em;
            line-height: 1.4;
        }

        .tracer-output .line { margin-bottom: 2px; }
        .tracer-output .prefix-bracket { color: #888; }
        .tracer-output .log-info { color: #33ff33; }
        .tracer-output .log-warn { color: #ffcc00; }
        .tracer-output .log-error { color: #ff3333; }
        .tracer-output .log-debug { color: #888; }

        .indicators-section { margin-top: 20px; }

        .indicator-row {
            display: flex;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid #222;
        }

        .indicator-type {
            color: #ffcc00;
            width: 80px;
            font-size: 0.85em;
        }

        .indicator-value {
            color: #33ff33;
            font-size: 0.9em;
        }

        .hash-display {
            background: #0a0a0a;
            padding: 10px;
            margin: 10px 0;
            border-left: 3px solid #333;
            font-size: 0.85em;
        }

        .hash-row {
            display: flex;
            margin: 3px 0;
        }

        .hash-label {
            color: #888;
            width: 80px;
        }

        .hash-value {
            color: #c0c0c0;
            word-break: break-all;
        }

        .loading {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #ffcc00;
        }

        .spinner {
            width: 12px;
            height: 12px;
            border: 2px solid #333;
            border-top-color: #ff3333;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #444; }
    </style>
</head>
<body>
    <div class="container">
        <pre class="ascii-header">
    /$$$$$$$  /$$$$$$$$ /$$$$$$   /$$$$$$   /$$$$$$  /$$   /$$  /$$$$$$
   | $$__  $$| $$_____//$$__  $$ /$$__  $$ /$$__  $$| $$  | $$ /$$__  $$
   | $$  \ $$| $$     | $$  \__/| $$  \ $$| $$  \__/| $$  | $$| $$  \__/
   | $$$$$$$/| $$$$$  | $$ /$$$$| $$$$$$$$|  $$$$$$ | $$  | $$|  $$$$$$
   | $$____/ | $$__/  | $$|_  $$| $$__  $$ \____  $$| $$  | $$ \____  $$
   | $$      | $$     | $$  \ $$| $$  | $$ /$$  \ $$| $$  | $$ /$$  \ $$
   | $$      | $$$$$$$$|  $$$$$$/| $$  | $$|  $$$$$$/|  $$$$$$/|  $$$$$$/
   |__/      |________/ \______/ |__/  |__/ \______/  \______/  \______/

              ‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó     ‚ñà‚ñà‚ïó    ‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
              ‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë    ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù
              ‚ñà‚ñà‚ïî‚ñà‚ñà‚ñà‚ñà‚ïî‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë ‚ñà‚ïó ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
              ‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù
              ‚ñà‚ñà‚ïë ‚ïö‚ïê‚ïù ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ïö‚ñà‚ñà‚ñà‚ïî‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
              ‚ïö‚ïê‚ïù     ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
                           ùô∞ ùöó ùöä ùöï ùö¢ ùöú ùöí ùöú   ùôø ùöï ùöä ùöù ùöè ùöò ùöõ ùöñ
        </pre>

        <div class="card">
            <div class="card-title">Binary Analysis & Malware Family Classification</div>
            <div class="card-subtitle">Upload a malware sample for static and dynamic analysis</div>
            <div class="note">Note: Analysis is performed in isolated containers. Large files may take longer to process.</div>

            <div class="upload-form">
                <div class="file-input-wrapper">
                    <button class="file-btn" onclick="document.getElementById('fileInput').click()">Choose File</button>
                    <span class="file-name" id="fileName">No file selected</span>
                    <input type="file" id="fileInput">
                </div>

                <button class="analyze-btn" id="analyzeBtn" onclick="analyzeFile()">Analyze Sample</button>
            </div>

            <div id="uploadStatus"></div>
        </div>

        <div class="card" id="resultsCard" style="display: none;">
            <div id="results"></div>
        </div>

        <div class="card" id="tracerCard" style="display: none;">
            <div class="card-title">Tracer Output:</div>
            <div class="tracer-output" id="tracerOutput"></div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let currentSampleId = null;
        let selectedFile = null;

        const fileInput = document.getElementById('fileInput');
        const fileName = document.getElementById('fileName');

        fileInput.addEventListener('change', (e) => {
            selectedFile = e.target.files[0];
            if (selectedFile) {
                fileName.textContent = selectedFile.name;
                fileName.classList.add('has-file');
            } else {
                fileName.textContent = 'No file selected';
                fileName.classList.remove('has-file');
            }
        });

        document.body.addEventListener('dragover', (e) => e.preventDefault());
        document.body.addEventListener('drop', (e) => {
            e.preventDefault();
            const file = e.dataTransfer.files[0];
            if (file) {
                selectedFile = file;
                fileName.textContent = file.name;
                fileName.classList.add('has-file');
            }
        });

        function log(message, type = 'info') {
            const tracerCard = document.getElementById('tracerCard');
            const tracerOutput = document.getElementById('tracerOutput');
            tracerCard.style.display = 'block';
            
            const prefixes = { 'info': '[=]', 'success': '[+]', 'error': '[!]', 'warn': '[*]', 'debug': '[-]' };
            const line = document.createElement('div');
            line.className = 'line';
            line.innerHTML = '<span class="prefix-bracket log-' + type + '">' + prefixes[type] + '</span> <span class="log-' + type + '">' + escapeHtml(message) + '</span>';
            tracerOutput.appendChild(line);
            tracerOutput.scrollTop = tracerOutput.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function analyzeFile() {
            if (!selectedFile) {
                showStatus('Please select a file first', 'error');
                return;
            }

            const analyzeBtn = document.getElementById('analyzeBtn');
            analyzeBtn.disabled = true;

            document.getElementById('tracerOutput').innerHTML = '';
            document.getElementById('results').innerHTML = '';
            document.getElementById('resultsCard').style.display = 'none';

            showStatus('Uploading ' + selectedFile.name + '...', 'info');
            log('Starting analysis of ' + selectedFile.name, 'info');
            log('File size: ' + selectedFile.size + ' bytes', 'debug');

            const formData = new FormData();
            formData.append('file', selectedFile);

            try {
                log('Uploading sample to analysis server...', 'info');
                const response = await fetch(API_BASE + '/api/upload/', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    currentSampleId = data.sample_id;
                    log('Upload successful', 'success');
                    log('Sample ID: ' + data.sample_id, 'info');
                    log('SHA256: ' + data.sha256, 'debug');
                    log('MD5: ' + data.md5, 'debug');
                    
                    showStatus('Upload successful! Starting analysis...', 'success');
                    monitorAnalysis(data.sample_id);
                } else {
                    log('Upload failed: ' + (data.detail || 'Unknown error'), 'error');
                    showStatus('Upload failed: ' + (data.detail || 'Unknown error'), 'error');
                    analyzeBtn.disabled = false;
                }
            } catch (error) {
                log('Connection error: ' + error.message, 'error');
                showStatus('Error: ' + error.message, 'error');
                analyzeBtn.disabled = false;
            }
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('uploadStatus');
            const prefixes = { 'success': '[+]', 'error': '[-]', 'info': '[*]' };
            statusDiv.innerHTML = '<div class="status-msg ' + type + '"><span class="prefix ' + type + '">' + prefixes[type] + '</span> ' + escapeHtml(message) + '</div>';
        }

        async function monitorAnalysis(sampleId) {
            const resultsCard = document.getElementById('resultsCard');
            const resultsDiv = document.getElementById('results');

            resultsCard.style.display = 'block';
            resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div><span>Analysis in progress...</span></div>';

            log('Waiting for analysis to complete...', 'info');

            const pollInterval = setInterval(async () => {
                try {
                    const response = await fetch(API_BASE + '/api/analysis/' + sampleId);
                    const data = await response.json();

                    if (data.status === 'completed' || data.status === 'failed') {
                        clearInterval(pollInterval);
                        document.getElementById('analyzeBtn').disabled = false;
                        
                        if (data.status === 'completed') {
                            log('Analysis complete!', 'success');
                            showStatus('Analysis complete!', 'success');
                        } else {
                            log('Analysis failed', 'error');
                            showStatus('Analysis failed', 'error');
                        }
                        
                        displayResults(data);
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                }
            }, 2000);
        }

        function displayResults(data) {
            const resultsDiv = document.getElementById('results');
            
            let classification = 'Unknown';
            let fileType = data.file_type || 'Unknown';
            let sampleType = 'unknown';
            
            if (data.analysis_results && data.analysis_results.static && data.analysis_results.static.results) {
                const s = data.analysis_results.static.results;
                
                // Detect file type from magic mime type
                const mimeType = s.file_type || data.file_type || '';
                if (mimeType.includes('x-executable') || mimeType.includes('x-sharedlib') || mimeType.includes('x-pie-executable')) {
                    sampleType = 'linux';
                    fileType = 'Linux ELF';
                } else if (mimeType.includes('x-dosexec') || mimeType.includes('x-msdownload') || (s.pe_info && Object.keys(s.pe_info).length > 0)) {
                    sampleType = 'windows';
                    fileType = 'Windows PE';
                } else if (mimeType.includes('x-mach')) {
                    sampleType = 'macos';
                    fileType = 'macOS Mach-O';
                } else {
                    fileType = mimeType || 'Unknown';
                }
                
                if (s.indicators && s.indicators.length > 5) classification = 'Suspicious';
                if (s.entropy > 7.5) classification = 'Packed/Encrypted';
                if (s.yara_matches && s.yara_matches.length > 0) classification = s.yara_matches[0].rule || 'Malware';
            }

            if (data.analysis_results && data.analysis_results.static && data.analysis_results.static.results) {
                const s = data.analysis_results.static.results;
                log('Loading static analysis results...', 'info');
                log('Entropy: ' + (s.entropy || 'N/A'), 'debug');
                log('Strings found: ' + (s.total_strings_found || 0), 'debug');
                
                if (s.indicators) {
                    s.indicators.forEach(function(ind) {
                        log('Found ' + ind.type + ': ' + ind.value, 'warn');
                    });
                }
            }

            if (data.analysis_results && data.analysis_results.dynamic && data.analysis_results.dynamic.results) {
                const d = data.analysis_results.dynamic.results;
                log('Loading dynamic analysis results...', 'info');
                if (d.execution_method) log('Execution method: ' + d.execution_method, 'debug');
                if (d.behavior_summary) {
                    log('Processes: ' + (d.behavior_summary.process_count || 0), 'debug');
                    log('Files created: ' + (d.behavior_summary.files_created || 0), 'debug');
                    log('Network connections: ' + (d.behavior_summary.network_connections_count || 0), 'debug');
                }
                if (d.errors && d.errors.length > 0) {
                    d.errors.forEach(function(err) { log('Dynamic error: ' + err, 'error'); });
                }
            }

            let html = '<div class="result-header">[+] Analysis complete!</div>' +
                '<div class="result-classification">[+] Result: ' + classification + '</div>' +
                '<div class="result-meta">' +
                '<span>File Type: ' + fileType + '</span>' +
                '<span>| Sample Type: ' + sampleType + '</span>' +
                '<span>| Size: ' + data.file_size + ' bytes</span>' +
                '<span>| SHA256: ' + data.sha256.substring(0, 16) + '...</span>' +
                '</div>' +
                '<div class="hash-display">' +
                '<div class="hash-row"><span class="hash-label">SHA256:</span><span class="hash-value">' + data.sha256 + '</span></div>' +
                '<div class="hash-row"><span class="hash-label">MD5:</span><span class="hash-value">' + data.md5 + '</span></div>' +
                '<div class="hash-row"><span class="hash-label">SHA1:</span><span class="hash-value">' + data.sha1 + '</span></div>' +
                '<div class="hash-row"><span class="hash-label">Filename:</span><span class="hash-value">' + data.original_filename + '</span></div>' +
                '</div>';

            if (data.analysis_results && data.analysis_results.static && data.analysis_results.static.results) {
                const s = data.analysis_results.static.results;
                let entropyNote = s.entropy > 7.5 ? '(HIGH - possibly packed)' : s.entropy > 6 ? '(moderate)' : '(normal)';
                html += '<div class="card-title" style="margin-top: 20px;">Static Analysis</div>' +
                    '<div class="hash-display">' +
                    '<div class="hash-row"><span class="hash-label">Entropy:</span><span class="hash-value">' + (s.entropy || 'N/A') + ' ' + entropyNote + '</span></div>' +
                    '<div class="hash-row"><span class="hash-label">Strings:</span><span class="hash-value">' + (s.total_strings_found || 0) + ' found</span></div>' +
                    '<div class="hash-row"><span class="hash-label">YARA:</span><span class="hash-value">' + (s.yara_matches ? s.yara_matches.length : 0) + ' matches</span></div>' +
                    '</div>';
            }

            if (data.network_indicators && data.network_indicators.length > 0) {
                html += '<div class="card-title" style="margin-top: 20px;">Network Indicators (' + data.network_indicators.length + ')</div>' +
                    '<div class="indicators-section">';
                data.network_indicators.forEach(function(indicator) {
                    html += '<div class="indicator-row">' +
                        '<span class="indicator-type">[' + indicator.type.toUpperCase() + ']</span>' +
                        '<span class="indicator-value">' + indicator.value + '</span></div>';
                });
                html += '</div>';
            }

            if (data.analysis_results && data.analysis_results.dynamic && data.analysis_results.dynamic.results) {
                const d = data.analysis_results.dynamic.results;
                const netConns = d.network_connections || [];
                const dnsQueries = d.dns_queries || [];
                const urlsFound = d.urls_found || [];
                const commandsExec = d.commands_executed || [];
                const processesKilled = d.processes_killed || [];
                const filesAccessed = d.files_accessed || [];
                const totalNetActivity = netConns.length + dnsQueries.length;
                
                html += '<div class="card-title" style="margin-top: 20px;">Dynamic Analysis</div>' +
                    '<div class="hash-display">' +
                    '<div class="hash-row"><span class="hash-label">Executed:</span><span class="hash-value">' + (d.executed ? 'Yes' : 'No') + '</span></div>' +
                    '<div class="hash-row"><span class="hash-label">Method:</span><span class="hash-value">' + (d.execution_method || 'N/A') + '</span></div>' +
                    '<div class="hash-row"><span class="hash-label">Processes:</span><span class="hash-value">' + (d.behavior_summary ? d.behavior_summary.process_count || 0 : 0) + '</span></div>' +
                    '<div class="hash-row"><span class="hash-label">Commands:</span><span class="hash-value">' + commandsExec.length + ' executed</span></div>' +
                    '<div class="hash-row"><span class="hash-label">Files:</span><span class="hash-value">' + filesAccessed.length + ' accessed</span></div>' +
                    '<div class="hash-row"><span class="hash-label">Network:</span><span class="hash-value">' + totalNetActivity + ' attempts (' + netConns.length + ' conn, ' + dnsQueries.length + ' DNS)</span></div>' +
                    '</div>';
                
                // Show commands executed by malware
                if (commandsExec.length > 0) {
                    html += '<div class="card-title" style="margin-top: 15px;">Commands Executed</div>' +
                        '<div class="tracer-output" style="max-height: 150px;">';
                    commandsExec.forEach(function(cmd) {
                        html += '<div class="line log-error">[EXEC] ' + escapeHtml(cmd.cmdline || cmd.binary) + '</div>';
                    });
                    html += '</div>';
                }
                
                // Show processes killed
                if (processesKilled.length > 0) {
                    html += '<div class="card-title" style="margin-top: 15px;">Processes Killed</div>' +
                        '<div class="tracer-output" style="max-height: 100px;">';
                    processesKilled.forEach(function(p) {
                        html += '<div class="line log-error">[KILL] PID ' + p.pid + ' (signal: ' + p.signal + ')</div>';
                    });
                    html += '</div>';
                }
                
                // Show files accessed
                if (filesAccessed.length > 0) {
                    html += '<div class="card-title" style="margin-top: 15px;">Files Accessed</div>' +
                        '<div class="tracer-output" style="max-height: 150px;">';
                    filesAccessed.forEach(function(f) {
                        var opClass = f.operation === 'write' ? 'log-warning' : 'log-debug';
                        html += '<div class="line ' + opClass + '">[' + f.operation.toUpperCase() + '] ' + escapeHtml(f.path) + '</div>';
                    });
                    html += '</div>';
                }
                
                // Show URLs found in sample
                if (urlsFound.length > 0) {
                    html += '<div class="card-title" style="margin-top: 15px;">URLs/Hostnames in Sample</div>' +
                        '<div class="tracer-output" style="max-height: 120px;">';
                    urlsFound.forEach(function(u) {
                        html += '<div class="line log-error">[' + u.type.toUpperCase() + '] ' + escapeHtml(u.url) + '</div>';
                    });
                    html += '</div>';
                }
                
                // Show network connection details
                if (netConns.length > 0 || dnsQueries.length > 0) {
                    html += '<div class="card-title" style="margin-top: 15px;">Network Activity</div>' +
                        '<div class="tracer-output" style="max-height: 150px;">';
                    netConns.forEach(function(conn) {
                        html += '<div class="line log-warning">[CONN] ' + conn.dst_ip + ':' + conn.dst_port + ' (' + (conn.protocol || 'tcp') + ')</div>';
                    });
                    dnsQueries.forEach(function(dns) {
                        html += '<div class="line log-info">[DNS] Query to ' + dns.server + ':' + dns.port + '</div>';
                    });
                    html += '</div>';
                }
            }

            // CAPA Capability Analysis
            if (data.analysis_results && data.analysis_results.static && data.analysis_results.static.results && 
                data.analysis_results.static.results.capa) {
                const capa = data.analysis_results.static.results.capa;
                const caps = capa.capabilities || [];
                const attack = capa.attack || [];
                const mbc = capa.mbc || [];
                
                if (caps.length > 0 || attack.length > 0 || mbc.length > 0) {
                    html += '<div class="card-title" style="margin-top: 20px;">CAPA Capabilities</div>';
                    
                    // ATT&CK Techniques
                    if (attack.length > 0) {
                        html += '<div class="hash-display" style="margin-bottom: 10px;">' +
                            '<div class="hash-row"><span class="hash-label">ATT&CK:</span><span class="hash-value">' + attack.length + ' techniques</span></div>' +
                            '</div>' +
                            '<div class="tracer-output" style="max-height: 120px;">';
                        attack.forEach(function(att) {
                            html += '<div class="line log-error">[' + (att.id || 'ATT&CK') + '] ' + escapeHtml(att.technique || att.tactic || 'Unknown') + '</div>';
                        });
                        html += '</div>';
                    }
                    
                    // MBC Behaviors
                    if (mbc.length > 0) {
                        html += '<div class="hash-display" style="margin-top: 10px; margin-bottom: 10px;">' +
                            '<div class="hash-row"><span class="hash-label">MBC:</span><span class="hash-value">' + mbc.length + ' behaviors</span></div>' +
                            '</div>' +
                            '<div class="tracer-output" style="max-height: 120px;">';
                        mbc.forEach(function(m) {
                            html += '<div class="line log-warning">[' + (m.id || 'MBC') + '] ' + escapeHtml(m.behavior || m.objective || 'Unknown') + '</div>';
                        });
                        html += '</div>';
                    }
                    
                    // Capabilities
                    if (caps.length > 0) {
                        html += '<div class="hash-display" style="margin-top: 10px; margin-bottom: 10px;">' +
                            '<div class="hash-row"><span class="hash-label">Capabilities:</span><span class="hash-value">' + caps.length + ' detected</span></div>' +
                            '</div>' +
                            '<div class="tracer-output" style="max-height: 150px;">';
                        caps.forEach(function(cap) {
                            const ns = cap.namespace ? '[' + cap.namespace + '] ' : '';
                            html += '<div class="line log-info">' + ns + escapeHtml(cap.name) + '</div>';
                        });
                        html += '</div>';
                    }
                } else if (capa.note) {
                    html += '<div class="card-title" style="margin-top: 20px;">CAPA</div>' +
                        '<div class="hash-display"><div class="hash-row"><span class="hash-label">Note:</span><span class="hash-value">' + escapeHtml(capa.note) + '</span></div></div>';
                } else if (capa.error) {
                    html += '<div class="card-title" style="margin-top: 20px;">CAPA</div>' +
                        '<div class="hash-display"><div class="hash-row"><span class="hash-label">Error:</span><span class="hash-value">' + escapeHtml(capa.error) + '</span></div></div>';
                }
            }

            if (data.analysis_results && data.analysis_results.static && data.analysis_results.static.results && 
                data.analysis_results.static.results.strings && data.analysis_results.static.results.strings.length > 0) {
                const strings = data.analysis_results.static.results.strings;
                html += '<div class="card-title" style="margin-top: 20px;">Strings (sample)</div>' +
                    '<div class="tracer-output" style="max-height: 200px;">';
                strings.slice(0, 20).forEach(function(str) {
                    html += '<div class="line log-debug">' + escapeHtml(str.substring(0, 100)) + '</div>';
                });
                if (strings.length > 20) {
                    html += '<div class="line log-info">... and ' + (strings.length - 20) + ' more strings</div>';
                }
                html += '</div>';
            }

            resultsDiv.innerHTML = html;
        }
    </script>
</body>
</html>
